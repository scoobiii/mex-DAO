<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cons√≥rcio MEX Energia</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0e1a;
            color: #ffffff;
            overflow-x: hidden;
        }

        /* Header Fixo */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 80px;
            background: linear-gradient(135deg, rgba(26, 31, 46, 0.8) 0%, rgba(45, 55, 72, 0.8) 100%);
            border-bottom: 2px solid #4299e1;
            z-index: 1000;
            display: flex;
            align-items: center;
            padding: 0 30px;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(66, 153, 225, 0.2);
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            color: #4299e1;
            margin-right: 40px;
        }

        .nav-menu {
            display: flex;
            gap: 20px;
            flex: 1;
            align-items: center;
        }

        .location-selector {
            display: flex;
            gap: 10px;
            margin: 0 20px;
        }

        .location-select {
            background: rgba(45, 55, 72, 0.8);
            border: 1px solid #4a5568;
            color: #ffffff;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            min-width: 140px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .location-select:hover {
            border-color: #4299e1;
            background: rgba(66, 153, 225, 0.1);
        }

        .location-select:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 2px rgba(66, 153, 225, 0.2);
        }

        .location-select option {
            background: #2d3748;
            color: #ffffff;
        }

        .nav-item {
            position: relative;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 14px;
        }

        .nav-item:hover, .nav-item.active {
            background: rgba(66, 153, 225, 0.2);
            color: #4299e1;
        }

        .submenu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 10px;
            background: linear-gradient(135deg, rgba(26, 31, 46, 0.9) 0%, rgba(45, 55, 72, 0.9) 100%);
            border: 1px solid #4a5568;
            border-radius: 8px;
            padding: 10px;
            min-width: 280px;
            z-index: 1002;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(5px);
        }

        .nav-item:hover > .submenu {
            display: block;
        }

        .submenu a {
            display: block;
            color: #cbd5e0;
            padding: 10px 15px;
            text-decoration: none;
            border-radius: 6px;
            font-size: 13px;
            transition: all 0.2s ease-in-out;
            white-space: nowrap;
        }

        .submenu a:hover {
            background: rgba(66, 153, 225, 0.2);
            color: #4299e1;
        }

        /* Sidebar Fixa */
        .sidebar {
            position: fixed;
            left: 0;
            top: 80px;
            width: 280px;
            height: calc(100vh - 80px);
            background: linear-gradient(180deg, #1a202c 0%, #2d3748 100%);
            border-right: 1px solid #4a5568;
            padding: 20px;
            overflow-y: auto;
            z-index: 900;
        }

        .filter-section {
            margin-bottom: 30px;
        }

        .filter-title {
            font-size: 14px;
            font-weight: 600;
            color: #cbd5e0;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .filter-btn {
            background: rgba(74, 85, 104, 0.3);
            border: 1px solid rgba(74, 85, 104, 0.5);
            color: #cbd5e0;
            padding: 10px 14px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 13px;
            font-weight: 500;
            text-align: left;
        }

        .filter-btn:hover {
            background: rgba(66, 153, 225, 0.2);
            border-color: #4299e1;
            color: #4299e1;
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #4299e1, #3182ce);
            border-color: #4299e1;
            color: white;
            box-shadow: 0 4px 12px rgba(66, 153, 225, 0.3);
        }

        /* Main Content */
        .main-content {
            margin-left: 280px;
            margin-top: 80px;
            padding: 20px;
            min-height: calc(100vh - 80px);
        }

        .content-header {
            margin-bottom: 20px;
        }

        .content-title {
            font-size: 28px;
            font-weight: 700;
            color: #ffffff;
        }

        .content-subtitle {
            font-size: 14px;
            color: #a0aec0;
        }

        .metrics-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
            border: 1px solid #4a5568;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(66, 153, 225, 0.2);
            border-color: #4299e1;
        }

        .metric-value {
            font-size: 24px;
            font-weight: 700;
            color: #4299e1;
            margin-bottom: 5px;
        }

        .metric-label {
            font-size: 12px;
            color: #a0aec0;
        }

        /* Treemap Container */
        .treemap-container {
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            border: 1px solid #4a5568;
            border-radius: 12px;
            padding: 20px;
            min-height: 600px;
        }

        .treemap-title {
            font-size: 18px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #4a5568;
        }

        .treemap-rect {
            stroke: #2d3748;
            stroke-width: 2;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .treemap-rect:hover {
            stroke: #4299e1;
            stroke-width: 3;
            filter: brightness(1.2);
        }

        .treemap-text, .treemap-value {
            pointer-events: none;
            font-family: inherit;
            fill: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }
        
        .treemap-text { font-weight: 600; }
        .treemap-value { font-weight: 700; }

        /* Tooltip */
        .tooltip {
            position: absolute;
            background: rgba(26, 32, 44, 0.95);
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-size: 13px;
            pointer-events: none;
            z-index: 1000;
            backdrop-filter: blur(10px);
            border: 1px solid #4a5568;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            max-width: 280px;
            display: none; /* Hidden by default */
        }
        
        .legend {
            background: rgba(45, 55, 72, 0.5);
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }

        .legend-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #cbd5e0;
        }

        .legend-item {
            display: flex;
            align-items: center;
            font-size: 12px;
            color: #a0aec0;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            margin-right: 8px;
        }

        /* Loading Spinner */
        .loading {
            display: flex; justify-content: center; align-items: center;
            height: 400px; font-size: 16px; color: #a0aec0;
        }
        .loading::after {
            content: ''; width: 20px; height: 20px;
            border: 2px solid #4a5568; border-top-color: #4299e1;
            border-radius: 50%; animation: spin 1s linear infinite; margin-left: 10px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Estilos do Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .modal-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-content {
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid #4a5568;
            width: 100%;
            max-width: 450px;
            margin: 20px;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }

        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }

        .modal-header { padding: 20px; border-bottom: 1px solid #4a5568; }
        .modal-header h3 { font-size: 18px; font-weight: 600; color: #ffffff; }
        .modal-body { padding: 20px; font-size: 14px; color: #cbd5e0; }
        .modal-domain {
            margin-top: 8px; font-weight: 500; color: #4299e1;
            background: rgba(66, 153, 225, 0.1); padding: 8px 12px;
            border-radius: 6px; word-break: break-all;
        }

        .modal-footer {
            padding: 20px; display: flex; justify-content: flex-end; gap: 12px;
            background: rgba(26, 32, 44, 0.5); border-top: 1px solid #4a5568;
            border-radius: 0 0 12px 12px;
        }

        .modal-btn-primary, .modal-btn-secondary {
            padding: 10px 20px; border-radius: 6px; font-size: 14px;
            font-weight: 500; cursor: pointer; transition: all 0.2s ease;
            border: none; text-decoration: none; display: inline-block; text-align: center;
        }

        .modal-btn-primary {
            background: linear-gradient(135deg, #4299e1, #3182ce);
            color: white; box-shadow: 0 4px 12px rgba(66, 153, 225, 0.3);
        }
        .modal-btn-primary:hover { filter: brightness(1.1); }
        .modal-btn-secondary { background: #4a5568; color: #cbd5e0; }
        .modal-btn-secondary:hover { background: #718096; }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); transition: transform 0.3s ease; }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-left: 0; }
            .header { padding: 0 15px; }
            .nav-menu { display: none; }
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.1.1",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.1.1/",
    "react/": "https://aistudiocdn.com/react@^19.1.1/",
    "d3": "https://aistudiocdn.com/d3@^7.9.0"
  }
}
</script>
</head>
<body>
    <header class="header">
        <div class="logo">MEX Energia</div>
        <nav class="nav-menu">
            <div class="nav-item active">Dashboard</div>
            <div class="nav-item">Dor/Oportunidade
                <div class="submenu">
                    <a href="https://tech.facebook.com/engineering/2021/11/open-compute-project/">M√°gica 1: Facebook destr√≥i PUE</a>
                    <a href="https://www.facebook.com/PrinevilleDataCenter/videos/10150385588936731/">M√°gica 1.1: V√≠deo Prineville DC</a>
                    <a href="https://www.ashrae.org/file%20library/technical%20resources/bookstore/ashrae_tc0909_power_white_paper_22_june_2016_revised.pdf">M√°gica 2: ASHRAE eleva teto 27¬∞C</a>
                    <a href="https://www.vertiv.com/499702/globalassets/products/thermal-management/in-row-cooling/vertiv_ap__elevated_return_air_temperature__-_en_-_asia_302442_0.pdf">M√°gica 3: Ind√∫stria se adequa</a>
                    <a href="https://static.googleusercontent.com/media/www.google.com/pt-BR//about/datacenters/efficiency/internal/assets/machine-learning-applicationsfor-datacenter-optimization-finalv2.pdf">M√°gica 4: DeepMind reduz PUE 40%</a>
                    <a href="https://deepmind.google/discover/blog/deepmind-ai-reduces-google-data-centre-cooling-bill-by-40/">M√°gica 4.0: Blog DeepMind</a>
                    <a href="https://github.com/LaurentVeyssier/Minimize-Energy-consumption-with-Deep-Learning-model">M√°gica 4.1: GitHub Minimizar Consumo</a>
                    <a href="https://status.cloud.google.com/incidents/fmEL9i2fArADKawkZAa2/">Resili√™ncia Clim√°tica (Google Cloud)</a>
                </div>
            </div>
            <div class="nav-item">ESC
                <div class="submenu">
                    <a href="https://wawpuibt.manus.space/">Plataforma ESC</a>
                </div>
            </div>
            <div class="nav-item">InteLegis
                <div class="submenu">
                    <a href="https://www25.senado.leg.br/web/atividade/materias/-/materia/164831">REDATA</a>
                    <a href="https://agenciabrasil.ebc.com.br/economia/noticia/2025-05/haddad-anuncia-que-pretende-acelerar-desoneracao-de-data-centers">REDATA_25/30_2T</a>
                    <a href="https://claude.ai/public/artifacts/3cf19164-d0d5-44b2-aabd-368332dde7dd">REDATA KIDS</a>
                    <a href="https://scoobiii.github.io/mex-DAO/">MEX DAO</a>
                    <a href="https://3000-ipt3dcolgqg609yx8xz8f-e7a55fad.manusvm.computer/">Energia Social</a>
                    <a href="https://claude.ai/public/artifacts/0c2f1ebb-d2dd-45e3-9063-e7c336838af7">MEX Intelig√™ncia</a>
                    <a href="https://github.com/scoobiii/mex-dashboard/blob/main/projetos_lei_energia.pdf">PetaLegis</a>
                    <a href="https://yemdxbhh.manus.space/">WorkShop 100% Mau√°</a>
                </div>
            </div>
            <div class="location-selector">
                <select id="countrySelect" class="location-select">
                    <option value="brazil">üáßüá∑ Brasil</option>
                    <option value="usa" disabled>üá∫üá∏ EUA (Em breve)</option>
                </select>
                <select id="citySelect" class="location-select">
                    <option value="">Selecione uma cidade...</option>
                </select>
            </div>
        </nav>
    </header>

    <aside class="sidebar">
        <div class="filter-section">
            <div class="filter-title">üìä Categorias</div>
            <div class="filter-grid">
                <button class="filter-btn active" data-filter="all">üéØ Todos os Indicadores</button>
                <button class="filter-btn" data-filter="energy">‚ö° Energia & Emiss√µes</button>
                <button class="filter-btn" data-filter="social">üë• Indicadores Sociais</button>
                <button class="filter-btn" data-filter="environment">üå± Meio Ambiente</button>
                <button class="filter-btn" data-filter="economy">üí∞ Economia Verde</button>
                <button class="filter-btn" data-filter="worldbank">üè¶ World Bank</button>
            </div>
        </div>
        <div class="filter-section">
            <div class="filter-title">üé® Visualiza√ß√£o</div>
            <div class="filter-grid">
                <button class="filter-btn active" data-view="meta">% da Meta Atingida</button>
                <button class="filter-btn" data-view="gap">Gap vs Helsinki</button>
                <button class="filter-btn" data-view="performance">Performance Atual</button>
            </div>
        </div>
        <div class="legend">
            <div class="legend-title">Legenda de Cores</div>
            <div class="legend-grid" style="grid-template-columns: 1fr;">
                <div class="legend-item"><div class="legend-color" style="background: #22c55e;"></div><span>Meta Atingida (80%+)</span></div>
                <div class="legend-item"><div class="legend-color" style="background: #3b82f6;"></div><span>Pr√≥ximo (60-80%)</span></div>
                <div class="legend-item"><div class="legend-color" style="background: #f59e0b;"></div><span>Moderado (40-60%)</span></div>
                <div class="legend-item"><div class="legend-color" style="background: #ef4444;"></div><span>Cr√≠tico (&lt;40%)</span></div>
            </div>
        </div>
    </aside>

    <main class="main-content">
        <div id="dashboard-view">
            <div class="content-header">
                <h1 class="content-title">Dashboard de Sustentabilidade</h1>
                <p class="content-subtitle">Monitoramento em tempo real dos indicadores de Mau√° (GDS-Index)</p>
            </div>
            <div class="metrics-overview">
                <!-- Metric cards will be populated by script -->
            </div>
            <div class="treemap-container">
                <h2 class="treemap-title">Treemap de Indicadores - Percentual da Meta Atingida</h2>
                <div id="treemap" class="loading">Carregando dados...</div>
            </div>
        </div>
    </main>

    <div class="tooltip" id="tooltip"></div>

    <!-- Modal de Confirma√ß√£o de Sa√≠da -->
    <div id="external-link-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Voc√™ est√° saindo do site</h3>
            </div>
            <div class="modal-body">
                <p>Voc√™ ser√° redirecionado para o seguinte destino:</p>
                <p id="modal-link-domain" class="modal-domain"></p>
            </div>
            <div class="modal-footer">
                <button id="modal-cancel-btn" class="modal-btn-secondary">Cancelar</button>
                <a id="modal-confirm-btn" href="#" target="_blank" rel="noopener noreferrer" class="modal-btn-primary">Continuar</a>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const mauaData = [
            { name: "PIB per capita", category: "worldbank", current: 9258, target: 54000, unit: "USD", trend: "up", priority: "high" },
            { name: "Consumo Energia", category: "worldbank", current: 2360, target: 4500, unit: "kWh", trend: "stable", priority: "medium" },
            { name: "Energia Renov√°vel", category: "energy", current: 45.2, target: 85, unit: "%", trend: "up", priority: "high" },
            { name: "Efici√™ncia Energ√©tica", category: "energy", current: 62.8, target: 90, unit: "%", trend: "up", priority: "high" },
            { name: "Redu√ß√£o CO2", category: "energy", current: 38.4, target: 80, unit: "%", trend: "up", priority: "critical" },
            { name: "Transporte Limpo", category: "energy", current: 34.6, target: 75, unit: "%", trend: "up", priority: "high" },
            { name: "Eletricidade Verde", category: "energy", current: 78.9, target: 95, unit: "%", trend: "up", priority: "medium" },
            { name: "Smart Grid", category: "energy", current: 25.3, target: 60, unit: "%", trend: "up", priority: "medium" },
            { name: "Qualidade do Ar", category: "social", current: 56.7, target: 90, unit: "IQA", trend: "up", priority: "critical" },
            { name: "Acesso √† √Ågua", category: "social", current: 89.3, target: 100, unit: "%", trend: "stable", priority: "high" },
            { name: "Saneamento", category: "social", current: 67.5, target: 100, unit: "%", trend: "up", priority: "high" },
            { name: "Educa√ß√£o Ambiental", category: "social", current: 71.2, target: 90, unit: "%", trend: "up", priority: "medium" },
            { name: "Sa√∫de P√∫blica", category: "social", current: 73.8, target: 95, unit: "%", trend: "stable", priority: "high" },
            { name: "Participa√ß√£o Cidad√£", category: "social", current: 52.4, target: 80, unit: "%", trend: "up", priority: "medium" },
            { name: "Inclus√£o Digital", category: "social", current: 64.7, target: 85, unit: "%", trend: "up", priority: "medium" },
            { name: "Gest√£o de Res√≠duos", category: "environment", current: 58.9, target: 95, unit: "%", trend: "up", priority: "high" },
            { name: "Biodiversidade", category: "environment", current: 41.7, target: 80, unit: "√≠ndice", trend: "down", priority: "critical" },
            { name: "Cobertura Verde", category: "environment", current: 35.6, target: 60, unit: "%", trend: "up", priority: "high" },
            { name: "Qualidade da √Ågua", category: "environment", current: 64.3, target: 90, unit: "IQA", trend: "stable", priority: "high" },
            { name: "Controle Polui√ß√£o", category: "environment", current: 48.2, target: 85, unit: "%", trend: "up", priority: "high" },
            { name: "Economia Circular", category: "environment", current: 32.1, target: 70, unit: "%", trend: "up", priority: "medium" },
            { name: "Investimento Verde", category: "economy", current: 29.7, target: 60, unit: "%", trend: "up", priority: "high" },
            { name: "Empregos Verdes", category: "economy", current: 15.4, target: 35, unit: "%", trend: "up", priority: "medium" },
            { name: "Inova√ß√£o Sustent√°vel", category: "economy", current: 51.6, target: 80, unit: "√≠ndice", trend: "up", priority: "high" },
            { name: "Startups Verdes", category: "economy", current: 23.8, target: 50, unit: "%", trend: "up", priority: "medium" },
            { name: "Financiamento ESG", category: "economy", current: 18.5, target: 40, unit: "%", trend: "up", priority: "medium" }
        ];

        const brazilianCities = [
            { name: "Mau√°", state: "SP", region: "Grande S√£o Paulo", active: true, population: 477781 },
            { name: "S√£o Paulo", state: "SP", region: "Grande S√£o Paulo", active: false, population: 12396372 },
            { name: "Santo Andr√©", state: "SP", region: "Grande S√£o Paulo", active: false, population: 721368 }
        ];

        let currentData = JSON.parse(JSON.stringify(mauaData)); // Deep copy
        let currentView = 'meta';
        let currentFilter = 'all';

        const calculateMetaPercentage = (current, target) => Math.min(100, (current / target) * 100);
        const getColorByMeta = percentage => {
            if (percentage >= 80) return '#22c55e'; if (percentage >= 60) return '#3b82f6';
            if (percentage >= 40) return '#f59e0b'; return '#ef4444';
        };

        function populateCitySelector() {
            const citySelect = document.getElementById('citySelect');
            citySelect.innerHTML = '';
            brazilianCities.forEach(city => {
                const option = document.createElement('option');
                option.value = city.name.toLowerCase().replace(/\s+/g, '-');
                option.textContent = city.name;
                option.disabled = !city.active;
                if (city.name === 'Mau√°') option.selected = true;
                citySelect.appendChild(option);
            });
        }

        function updateMetricCards() {
            const metricsContainer = document.querySelector('.metrics-overview');
            const categories = {
                'energy': { label: 'Energia & Emiss√µes', icon: '‚ö°' },
                'environment': { label: 'Gest√£o Ambiental', icon: 'üå±' },
                'social': { label: 'Indicadores Sociais', icon: 'üë•' },
                'economy': { label: 'Economia Verde', icon: 'üí∞' }
            };
            let html = '';
            for (const cat in categories) {
                const catData = currentData.filter(d => d.category === cat);
                const avg = catData.length > 0 ? catData.reduce((acc, d) => acc + calculateMetaPercentage(d.current, d.target), 0) / catData.length : 0;
                html += `
                    <div class="metric-card">
                        <div class="metric-icon">${categories[cat].icon}</div>
                        <div class="metric-value">${avg.toFixed(1)}%</div>
                        <div class="metric-label">${categories[cat].label}</div>
                    </div>`;
            }
            metricsContainer.innerHTML = html;
        }

        const treemapContainer = document.getElementById('treemap');
        const tooltip = d3.select('#tooltip');
        let svg;

        function updateTreemap() {
            if (!treemapContainer) return;
            treemapContainer.innerHTML = ''; // Clear previous
            
            const rect = treemapContainer.getBoundingClientRect();
            const width = rect.width;
            const height = 600;

            svg = d3.select('#treemap').append('svg').attr('width', width).attr('height', height);

            const filteredData = currentFilter === 'all' ? currentData : currentData.filter(d => d.category === currentFilter);
            const treeData = filteredData.map(d => {
                const metaPercentage = calculateMetaPercentage(d.current, d.target);
                let size = metaPercentage;
                let displayValue = `${metaPercentage.toFixed(1)}%`;
                if (currentView === 'gap') {
                    const gap = Math.max(0, 92.43 - metaPercentage);
                    size = gap + 10;
                    displayValue = `${gap.toFixed(1)}%`;
                } else if (currentView === 'performance') {
                    size = d.current;
                    displayValue = d.current.toFixed(1);
                }
                return { ...d, size: Math.max(5, size), displayValue, color: getColorByMeta(metaPercentage) };
            });

            const root = d3.hierarchy({ children: treeData }).sum(d => d.size).sort((a, b) => b.value - a.value);
            d3.treemap().size([width, height]).padding(3).round(true)(root);

            const cell = svg.selectAll('g').data(root.leaves()).enter().append('g')
                .attr('transform', d => `translate(${d.x0},${d.y0})`);

            cell.append('rect')
                .attr('width', d => d.x1 - d.x0).attr('height', d => d.y1 - d.y0)
                .attr('fill', d => d.data.color).attr('class', 'treemap-rect')
                .on('mouseover', (event, d) => {
                    tooltip.style('display', 'block').html(`<strong>${d.data.name}</strong><br/>Valor: ${d.data.current.toFixed(1)} ${d.data.unit}<br/>Meta: ${d.data.target} ${d.data.unit}`);
                })
                .on('mousemove', (event) => tooltip.style('left', (event.pageX + 15) + 'px').style('top', (event.pageY - 10) + 'px'))
                .on('mouseout', () => tooltip.style('display', 'none'));

            cell.append('text').attr('class', 'treemap-text').attr('x', 6).attr('y', 18)
                .text(d => d.data.name.length > 15 ? d.data.name.substring(0,15)+'...' : d.data.name);

            cell.append('text').attr('class', 'treemap-value').attr('x', 6).attr('y', 40)
                .text(d => d.data.displayValue);
        }
        
        // --- L√ìGICA DE NAVEGA√á√ÉO COM MODAL ---
        const allNavItems = document.querySelectorAll('.nav-menu .nav-item');
        const submenuLinks = document.querySelectorAll('.submenu a');
        const modal = document.getElementById('external-link-modal');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const modalLinkDomain = document.getElementById('modal-link-domain');

        function closeModal() {
            modal.classList.remove('visible');
            setTimeout(() => { if (!modal.classList.contains('visible')) modal.style.display = 'none'; }, 300);
        }

        function openModal(url) {
            try {
                const domain = new URL(url).hostname;
                modalLinkDomain.textContent = domain;
                modalConfirmBtn.href = url;
                modal.style.display = 'flex';
                setTimeout(() => modal.classList.add('visible'), 10);
            } catch (error) {
                console.error("Invalid URL:", url);
                window.open(url, '_blank', 'noopener,noreferrer');
            }
        }

        modalCancelBtn.addEventListener('click', closeModal);
        modalConfirmBtn.addEventListener('click', closeModal);
        modal.addEventListener('click', (event) => { if (event.target === modal) closeModal(); });
        document.addEventListener('keydown', (event) => { if (event.key === "Escape" && modal.classList.contains('visible')) closeModal(); });
        
        function setActiveNavItem(navItem) {
            allNavItems.forEach(item => item.classList.remove('active'));
            if (navItem) navItem.classList.add('active');
        }

        submenuLinks.forEach(link => {
            link.addEventListener('click', function(event) {
                event.preventDefault();
                openModal(this.href);
                setActiveNavItem(this.closest('.nav-item'));
            });
        });

        allNavItems.forEach(item => {
            item.addEventListener('click', function(event) {
                if (event.target === this && this.firstChild.textContent.trim() === 'Dashboard') {
                    setActiveNavItem(this);
                }
            });
        });

        // --- Event Listeners ---
        document.querySelectorAll('[data-filter]').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelector('[data-filter].active').classList.remove('active');
                this.classList.add('active');
                currentFilter = this.dataset.filter;
                updateTreemap();
            });
        });

        document.querySelectorAll('[data-view]').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelector('[data-view].active').classList.remove('active');
                this.classList.add('active');
                currentView = this.dataset.view;
                document.querySelector('.treemap-title').textContent = {
                    'meta': 'Treemap de Indicadores - Percentual da Meta Atingida',
                    'gap': 'Treemap de Indicadores - Gap vs Helsinki (92.43%)',
                    'performance': 'Treemap de Indicadores - Performance Atual'
                }[currentView];
                updateTreemap();
            });
        });

        window.addEventListener('resize', () => setTimeout(updateTreemap, 100));

        setInterval(() => {
            currentData.forEach(item => {
                const variation = (Math.random() - 0.5) * 0.3;
                item.current = Math.max(0, Math.min(item.target * 1.2, item.current + variation));
            });
            updateMetricCards();
            updateTreemap();
        }, 6000);

        // --- Inicializa√ß√£o ---
        function initializeApp() {
            populateCitySelector();
            updateMetricCards();
            updateTreemap();
            console.log('üöÄ MEX Energia: Dashboard initialized');
        }

        initializeApp();
    });
    </script>
</body>
</html>
